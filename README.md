# MyPlugin TerraAngel 插件模板

**作者**: 羽学  
**出处**: [TerraAngel-PLUGINS](https://github.com/UnrealMultiple/TerraAngel/blob/master/PLUGINS.md)  
**GitHub**: [插件模板仓库](https://github.com/1242509682/TerraAngelPluginTemplate)

> 集成了配置文件重载、控制台指令、Mono钩子事件、ImGuiUI、自动部署等功能的Terraria插件模板

---

## 🛠️ 核心功能
### 1. 定位传送
- 出生点/床/死亡地点/自定义传送点
- NPC/宝藏袋/微光湖/神庙祭坛/花苞
- 地牢/陨石

### 2. 事件管理器
- 环境事件：血月/日食/满月/下雨/沙尘暴/灯笼夜
- 入侵事件：史莱姆雨/哥布林入侵/雪人军团/海盗入侵/火星暴乱
- 特殊事件：南瓜月/霜月/陨石事件
- 时间调整功能

### 3. 辅助功能
- `H键`强制回血
- `K键`快速死亡复活
- `J键`自动使用物品
- 鼠标范围伤害NPC（不设伤害则以手上物品伤害作参考)

### 4. 物品管理器
- **反重力药水**：支持反重力球/反重力下挖矿放置/抓钩/智能光标
- **传送枪距离修改**：修改原版projectile.aiStyle(114)800格限制
- **物品编辑器**：修改手持物品属性（伤害/前缀/暴击/渔力等30+属性）
- **自动垃圾桶**：智能回收+排除表+物品返还功能
- **连锁挖矿**：自定义破坏图格ID+连锁范围
- **配方管理器**：
  - 自定义配方（支持向导查询,暂不支持合成站检测）
  - 解锁/忽略所有原版配方
  - 忽略所有配方合成站需求选项（含原版）
  - 原版配方导入修改
- **社交栏饰品生效**：前缀加成/盔甲防御/饰品功能开关
- **一键修改**：
  -  `P键`修改所有饰品前缀（排除盔甲槽）
  -  `O键`收藏背包+虚空袋物品（支持世界加载自动收藏）

### 5. NPC管理器
- **生成/复活**：在安全范围内按ID/名称生成NPC、复活城镇NPC
- **自动回血**：普通NPC/BOSS独立回血设置
- **自动对话系统**：
  - 距离触发+无敌保护
  - NPC专属行为：
    | NPC类型       | 功能选项                     |
    |--------------|----------------------------|
    | 向导         | 制作栏/指导语               |
    | 护士         | 禁言/自动治疗               |
    | 派对女孩     | 商店/音乐切换               |
    | 渔夫         | 清理任务(可配置消耗任务鱼)  |
    | 税收官       | 概率奖励系统                |
    | 树妖       | 打开商店/检查环境纯净度                |
    | 油漆工       | 打开喷漆商店/壁纸商店                |
    | 哥布林/发型师| 商店与功能界面切换          |
- **NPC商店编辑器**：
  - 自定义商品+多币种定价
  - 自定义解锁条件（BOSS/事件/月相/地图种子/环境等）
  - 不显示原版NPC售卖物品选项

### 6. 开发者支持
- 自动部署：编译时同步插件到TerraAngel插件路径,并删除原有配置文件
- 热重载：通过UI`重载插件`按钮
- 世界信息获取：地图名/大小/难度/进度/世界ID/角色名/IP/UUID

---

## 📜 更新日志
### v1.1.5
- 给修改传送枪距离加入了保存按钮（自动重载插件确保IL钩子能读取到最新配置参数生效)
- 给插件主UI加入了新按钮：重载插件、世界信息
- 自定义配方支持合成站与环境进度检测

### v1.1.4
- 定位传送优化：传送死亡地点与自定义传送支持识别当前世界ID(避免坐标错误问题)
- 物品管理加入了修改传送枪距离功能
- 给自动对话加入NPC商店编辑器功能：
  - 1.可在原版商品空槽位加入自定义商品
  - 2.也可以清空原版商店只显示自己商品
> ⚠️ 注意：NPC商店编辑器仅在使用自动对话时触发

### v1.1.3
- **自动对话功能优化**：
  - 1.正在对话的npc会暂时得到无敌(对护士渔夫无效)
  - 2.离开检测范围自动关闭对话栏(检测准确性提高)
  - 3.清理渔夫任务加入了是否消耗任务鱼
  - 4.清理渔夫任务后不再需要按Esc键刷新对话栏来获取奖励(实现全自动完成任务)
  - 5.与护士对话支持根据血量状态来自动关闭对话栏(实现全自动治疗)
  - 6.税收官给物品时使用正确的物品源
  - 7.特别处理1:哥布林工匠的重铸与商店切换、发型师售卖头发与商店切换、油漆工2个商店的切换
  - 8.特别处理2:向导(新手提示和打开制作栏)、树妖(打开商店和检查环境)、酒馆老板(新手提示和打开商店)、派对女孩(切换音乐和打开商店)
  - 9.将以上有特殊功能的封装到了"NPC自动对话行为设置"作为独立窗口节点树进行渲染

### v1.1.2
- 自定义配方不再需要合成站,移除合成站添加窗口
- 加入了NPC自动对话功能，当靠近NPC时自动弹出聊天窗口(有商店的自动打开商店)
- 插件初始化时可获取到当前地图信息（地图名、大小、难度、进度、ID）
- NPC自动对话等待时间从秒改为帧数
- 添加了税收官随机奖励物品功能
```[!NOTE]
  - 配方异常时请重启TerraAngel并删除本插件的配置文件来恢复
  - 修复移除配方时不会删除游戏内配方BUG
  - 修复重新添加和保存相同物品配方时无法更新配方材料BUG
  - 修复自动对话玩家距离NPC格数不准确的BUG
  - 修复自动对话护士不会主动治疗的BUG,并减少治疗费用
  - 修复清理渔夫任务在自动对话无法生效
  - 现清理渔夫任务不再使用Update()方法触发，直接按Esc关闭对话窗口(不再消耗任务鱼)
  - 移除清理渔夫任务间隔配置项(开启对话框立即刷新)
  - 修复油漆工商店只显示油漆不显示墙纸的问题（用ESC退出时切换）
```

### v1.1.1
- UI布局优化
- 新增连锁挖矿/NPC生成独立窗口
- 配方检查事件支持
- 世界加载自动收藏物品

### v1.1.0
- 新增图格编辑事件
- 连锁挖矿功能上线

### v1.0.9
- NPC管理功能：自动回血/复活城镇npc/生成指定npc
- 入侵事件逻辑优化
- 帧计算优化：自动使用物品/垃圾桶/伤害NPC

### v1.0.8
- **事件管理器上线**：
  - 环境控制：血月/日食/满月/下雨/沙尘暴/灯笼夜
  - 入侵控制：史莱姆雨/哥布林/雪人军团/海盗/火星暴乱
  - 特殊事件：南瓜月/霜月/陨石事件
  - 时间调整功能
- 传送新增陨石坐标
- 自动清理渔夫任务

### v1.0.7
- **定位传送系统**：
  - 基础点：出生点/床/死亡地点
  - 自定义坐标点
  - 目标点：NPC/宝藏袋/微光湖/神庙
  - 关键位置：世纪花苞/地牢入口

### v1.0.6
- **自动垃圾桶**：
  - 自动回收+排除表+物品返还
  - 搜索式物品管理界面
- 编译脚本优化：
  - 相对路径支持
  - 自动清理旧配置

### v1.0.5
- **反重力药水**：
  - 屏幕保持正常方向
  - 支持挖矿/放置/抓钩/智能光标
- 修复：
  - 收藏功能边界值问题
  - 服务器环境伤害鼠标范围NPC
  - 钩子初始化异常

### v1.0.4
- **社交栏饰品系统**：
  - 前缀加成开关
  - 盔甲防御开关
  - 饰品功能开关
- 收藏逻辑优化：新物品状态统一处理
- 依赖更新：需添加MonoMod组件（using.zip里有）

### v1.0.3
> *此版本纪念开发者父亲,在完成版本更新时,开发者父亲已经离开人世*
- 物品管理器音效反馈
- 模糊搜索算法优化
- 新增物品参数：
  - 渔力/镐力/斧力/锤力
  - 图格/墙壁ID
- 一键功能：
  - 饰品栏一键改前缀（仅适配大师难度）
  - 收藏虚空袋物品

### v1.0.2
- **物品编辑系统**：
  - 物品属性修改器（伤害/暴击等）
  - UI组件模块化
- 集成功能：
  - 自动使用物品
  - 鼠标范围伤害NPC

### v1.0.1
- **热重载架构**：
  - 编译后自动部署脚本
- 功能扩展：
  - 智能自杀/复活判定
  - 鼠标范围伤害系统
  - UI按键绑定框架

### v1.0.0
- 基础框架实现：
  - 配置文件系统
  - 自动回血功能
  - 指令系统（#heal/#reload）
---

## ⌨️ 指令系统
| 指令       | 语法          | 功能说明                     |
|------------|---------------|------------------------------|
| `#heal`    | `#heal 数值`  | 启用按键回血（可设回血量）   |
| `#kill`    | `#kill`       | 自杀与立即复活               |
| `#snpc`    | `#snpc`       | 鼠标范围伤害NPC              |
| `#autouse` | `#autouse`    | 自动使用物品                 |
| `#reload`  | `#reload`     | 重载配置文件                 |

---

## ⚙️ 配置文件
**路径**: `MyDocuments\MyGames\Terraria\TerraAngel\MyPlugin.json`  
```json
{
  "插件开关": true,
  "回血按键": 72,
  "开启快捷键回血": true,
  "回血值": 100,
  "自杀复活按键": 75,
  "快速自杀复活": true,
  "自动使用按键": 74,
  "自动使用物品": false,
  "使用间隔(帧)": 10,
  "鼠标范围伤害NPC": false,
  "鼠标范围伤害值": 0,
  "鼠标伤害NPC格数": 3,
  "鼠标伤害间隔(帧)": 30,
  "修改前缀按键": 80,
  "快速收藏按键": 79,
  "社交栏饰品开关按键": 78,
  "社交栏饰品加成开关": false,
  "恢复前缀加成": true,
  "恢复盔甲防御": true,
  "恢复饰品功能": true,
  "物品修改": true,
  "应用修改按键": 73,
  "修改物品": [],
  "忽略重力药水按键": 84,
  "忽略重力药水": true,
  "自动垃圾桶按键": 67,
  "自动垃圾桶": false,
  "自动垃圾桶同步间隔": 10,
  "自动垃圾桶表": [],
  "自定义传送点": {},
  "NPC自动回血按键": 0,
  "NPC自动回血": false,
  "普通NPC回血百分比": 1.0,
  "普通NPC回血间隔(秒)": 1,
  "允许Boss回血": false,
  "BOSS回血百分比": 0.1,
  "BOSS每次回血上限": 1000,
  "BOSS独立回血间隔(秒)": 3,
  "NPC复活按键": 36,
  "连锁挖矿按键": 86,
  "连锁挖矿开关": false,
  "连锁挖矿上限": 500,
  "连锁图格表": [ ... ],
  "进入世界收藏背包物品": false,
  "添加自定义配方": true,
  "解锁所有配方": false,
  "忽略工作站要求": false,
  "自定义配方列表": [ ... ],
  "NPC自动对话按键": 89,
  "清除钓鱼任务按键": 70,
  "NPC自动对话": true,
  "NPC自动对话的最小格数": 2,
  "NPC自动对话等待帧数": 30,
  "自动对话NPC无敌": true,
  "清除钓鱼任务": true,
  "消耗任务鱼": false,
  "护士禁言": false,
  "派对女孩切换音乐": true,
  "派对女孩打开商店": true,
  "向导是否提示指导语": true,
  "向导打开制作栏": true,
  "酒馆老板打开商店": true,
  "酒馆老板是否提示指导语": true,
  "油漆工打开喷漆商店": true,
  "油漆工打开壁纸商店": false,
  "树妖打开商店": true,
  "树妖检查环境": true,
  "哥布林打开商店": false,
  "哥布林打开重铸界面": true,
  "发型师卖头发": true,
  "发型师打开商店": false,
  "税务官自定义奖励": false,
  "税务官奖励列表": [ ... ],
  "自定义NPC商店表": [ ... ],
  "修改传送枪弹幕距离": true,
  "传送枪弹幕销毁距离": 64000.0
}
```

## 📦 安装与使用
1. 下载插件文件 `MyPlugin.TAPlugin..dll` 与`using.zip`,并解压`using.zip`
2. 启动游戏，点击`TerraAngel 插件` - `打开插件文件夹` 打开TerraAngel插件目录
3. 把`using.zip`解压的文件与`MyPlugin.TAPlugin..dll` 放入TerraAngel插件目录
4. 点击`TerraAngel 插件` - `点击插件名字` - `重载插件`

```bash
# 克隆仓库
git clone https://github.com/1242509682/TerraAngelPluginTemplate.git

# 构建插件
dotnet build -c Release
```

> **提示**: 使用前请备份存档，部分功能可能影响游戏平衡
